name: iOS Build and Sign

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: 'Export method (app-store, ad-hoc, development)'
        required: true
        default: 'app-store'

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Install CocoaPods
      run: cd ios && pod install
    
    - name: Build iOS
      run: flutter build ios --release --no-codesign
    
    - name: Import Code-Signing Certificates
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.P12_BASE64 }}
        p12-password: ${{ secrets.P12_PASSWORD }}
    
    - name: Import Provisioning Profile
      uses: apple-actions/import-provisioning-profile@v2
      with:
        provisioning-profile-base64: ${{ secrets.MOBILEPROVISION_BASE64 }}
    
    - name: Build and Sign IPA
      run: |
        xcodebuild -workspace ios/Runner.xcworkspace -scheme Runner -configuration Release -archivePath Runner.xcarchive archive
        xcodebuild -exportArchive -archivePath Runner.xcarchive -exportPath . -exportOptionsPlist ios/ExportOptions.plist
      env:
        EXPORT_METHOD: ${{ github.event.inputs.export_method }}
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: signed-ipa
        path: '*.ipa'
