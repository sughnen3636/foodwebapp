name: iOS Build and Upload to App Store

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: 'Export method (app-store, ad-hoc, development)'
        required: true
        default: 'app-store'

jobs:
  build-and-upload:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Install CocoaPods
      run: |
        cd ios
        pod install
    
    - name: Check secrets availability
      run: |
        if [ -z "${{ secrets.P12_BASE64 }}" ]; then
          echo "❌ P12_BASE64 secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.MOBILEPROVISION_BASE64 }}" ]; then
          echo "❌ MOBILEPROVISION_BASE64 secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.APPSTORE_API_PRIVATE_KEY }}" ]; then
          echo "❌ APPSTORE_API_PRIVATE_KEY secret is not set"
          exit 1
        fi
        echo "✅ All required secrets are available"
    
    - name: Import Code-Signing Certificates
      uses: apple-actions/import-codesign-certs@v1
      with:
        p12-file-base64: ${{ secrets.P12_BASE64 }}
        p12-password: ${{ secrets.P12_PASSWORD }}
    
    - name: Import Provisioning Profile
      run: |
        echo "${{ secrets.MOBILEPROVISION_BASE64 }}" | base64 --decode > profile.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
    
    - name: Build iOS with Flutter
      run: flutter build ios --release --no-codesign
    
    - name: Create Archive
      run: |
        xcodebuild -workspace ios/Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath Runner.xcarchive \
          archive
    
    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath . \
          -exportOptionsPlist ios/ExportOptions.plist
    
    - name: Setup App Store Connect API Key
      run: |
        mkdir -p ~/.appstoreconnect/private_keys
        echo "${{ secrets.APPSTORE_API_PRIVATE_KEY }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8
    
    - name: Upload to App Store Connect
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file *.ipa \
          --apiKey ${{ secrets.APPSTORE_KEY_ID }} \
          --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }}
    
    - name: Upload IPA as Artifact (Backup)
      uses: actions/upload-artifact@v4
      with:
        name: signed-ipa-uploaded
        path: '*.ipa'
