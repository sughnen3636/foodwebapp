name: iOS Build and Upload to App Store

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: 'Export method (app-store, ad-hoc, development)'
        required: true
        default: 'app-store'

jobs:
  build-and-upload:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Install CocoaPods
      run: |
        cd ios
        pod install
    
    - name: Check secrets availability
      run: |
        if [ -z "${{ secrets.IOS_P12_BASE64 }}" ]; then
          echo "❌ IOS_P12_BASE64 secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.IOS_MOBILEPROVISION }}" ]; then
          echo "❌ IOS_MOBILEPROVISION secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.ASC_API_KEY_BASE64 }}" ]; then
          echo "❌ ASC_API_KEY_BASE64 secret is not set"
          exit 1
        fi
        echo "✅ All required secrets are available"
    
    - name: Decode iOS signing files
      run: |
        echo "${{ secrets.IOS_P12_BASE64 }}" | base64 --decode > ios_cert.p12
        echo "${{ secrets.IOS_MOBILEPROVISION }}" | base64 --decode > app.mobileprovision
        echo "${{ secrets.ASC_API_KEY_BASE64 }}" | base64 --decode > AuthKey.p8
    
    - name: Install Apple certificate
      run: |
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import ios_cert.p12 -k build.keychain -P "${{ secrets.IOS_P12_PASSWORD }}" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
    
    - name: Install provisioning profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp app.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
    
    - name: Flutter build iOS
      run: flutter build ios --release --no-codesign
    
    - name: Export IPA
      run: |
        cd ios
        xcodebuild \
          -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -archivePath build/Runner.xcarchive \
          archive

        xcodebuild \
          -exportArchive \
          -archivePath build/Runner.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build/ipa
    
    - name: Upload to App Store Connect
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file ios/build/ipa/*.ipa \
          --apiKey ${{ secrets.ASC_KEY_ID }} \
          --apiIssuer ${{ secrets.ASC_ISSUER_ID }}
    
    - name: Upload IPA as Artifact (Backup)
      uses: actions/upload-artifact@v4
      with:
        name: signed-ipa-uploaded
        path: 'ios/build/ipa/*.ipa'
