name: iOS Export IPA for Manual Upload

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: 'Export method (app-store, ad-hoc, development)'
        required: true
        default: 'app-store'

jobs:
  export-ipa:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Install CocoaPods
      run: |
        cd ios
        pod install
    
    - name: Check secrets availability
      run: |
        if [ -z "${{ secrets.P12_BASE64 }}" ]; then
          echo "âŒ P12_BASE64 secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.MOBILEPROVISION_BASE64 }}" ]; then
          echo "âŒ MOBILEPROVISION_BASE64 secret is not set"
          exit 1
        fi
        echo "âœ… All required secrets are available"
    
    - name: Decode iOS signing files
      run: |
        echo "${{ secrets.P12_BASE64 }}" | base64 --decode > ios_cert.p12
        echo "${{ secrets.MOBILEPROVISION_BASE64 }}" | base64 --decode > app.mobileprovision
    
    - name: Install Apple certificate
      run: |
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        # Check if the file is a .p12 or .cer and handle accordingly
        file_type=$(file ios_cert.p12)
        echo "Certificate file type: $file_type"
        
        if [[ "$file_type" == *"PKCS"* ]] || [[ "$file_type" == *"data"* ]]; then
          echo "Importing P12 certificate with private key..."
          security import ios_cert.p12 -k build.keychain -P "${{ secrets.P12_PASSWORD }}" -T /usr/bin/codesign
        else
          echo "Installing CER certificate (public key only)..."
          security add-certificates -k build.keychain ios_cert.p12
        fi
        
        security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
        # List available certificates
        echo "Available certificates:"
        security find-identity -v -p codesigning build.keychain
    
    - name: Diagnose provisioning profile issue
      run: |
        echo "=== DIAGNOSTIC: Checking provisioning profile file ==="
        echo "Current directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        
        echo "=== Checking if app.mobileprovision exists ==="
        if [ -f app.mobileprovision ]; then
          echo "âœ“ app.mobileprovision file exists"
          echo "File size: $(wc -c < app.mobileprovision) bytes"
          echo "File type: $(file app.mobileprovision)"
          echo "First 100 bytes (hex): $(head -c 100 app.mobileprovision | xxd)"
        else
          echo "âœ— app.mobileprovision file NOT FOUND"
          echo "This explains why the profile installation is failing"
          exit 1
        fi
        
        echo "=== Attempting to decode profile ==="
        if security cms -D -i app.mobileprovision > decoded_profile.plist 2>&1; then
          echo "âœ“ Profile decoded successfully"
          echo "Decoded file size: $(wc -c < decoded_profile.plist) bytes"
          echo "First 200 characters of decoded profile:"
          head -c 200 decoded_profile.plist
        else
          echo "âœ— Failed to decode provisioning profile"
          echo "Security command error output:"
          security cms -D -i app.mobileprovision 2>&1 || true
          echo "Raw file content (first 500 bytes):"
          head -c 500 app.mobileprovision | cat -v
          exit 1
        fi
        
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        
        # Validate the decoded profile has required keys
        echo "=== Checking for required profile keys ==="
        if grep -q "<key>UUID</key>" decoded_profile.plist; then
          echo "âœ“ UUID key found"
        else
          echo "âœ— UUID key missing - profile may be invalid"
          echo "Profile content preview:"
          head -50 decoded_profile.plist
          exit 1
        fi
        
        if grep -q "<key>Name</key>" decoded_profile.plist; then
          echo "âœ“ Name key found"
        else
          echo "âœ— Name key missing"
        fi
        
        # Extract profile information
        UUID=$(plutil -extract UUID raw decoded_profile.plist 2>/dev/null || echo "")
        if [ -z "$UUID" ]; then
          UUID=$(grep -A1 "<key>UUID</key>" decoded_profile.plist | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n\r ')
        fi
        
        PROFILE_NAME=$(grep -A1 "<key>Name</key>" decoded_profile.plist | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
        TEAM_ID=$(grep -A1 "<key>TeamIdentifier</key>" decoded_profile.plist | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
        
        echo "=== Profile Details ==="
        echo "UUID: '$UUID'"
        echo "Name: '$PROFILE_NAME'"
        echo "Team ID: '$TEAM_ID'"
        
        # Validate extracted values
        if [ -z "$UUID" ]; then
          echo "âœ— Failed to extract UUID"
          exit 1
        fi
        
        if [ "$PROFILE_NAME" != "foodweb" ]; then
          echo "âš  Warning: Profile name is '$PROFILE_NAME', expected 'foodweb'"
        fi
        
        if [ "$TEAM_ID" != "6HB8RU2486" ]; then
          echo "âš  Warning: Team ID is '$TEAM_ID', expected '6HB8RU2486'"
        fi
        
        # Install the profile with proper UUID filename
        echo "=== Installing provisioning profile ==="
        cp app.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
        echo "âœ“ Installed profile as $UUID.mobileprovision"
        
        # Verify installation
        if [ -f ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision ]; then
          echo "âœ“ Profile installation verified"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
        else
          echo "âœ— Profile installation failed"
          exit 1
        fi
        
        # List all installed profiles
        echo "=== All installed profiles ==="
        ls -la ~/Library/MobileDevice/Provisioning\ Profiles/
    
    - name: Configure Runner project for manual signing
      run: |
        cd ios
        # Add CODE_SIGN_STYLE to Runner build configurations
        /usr/libexec/PlistBuddy -c "Add :objects:97C147061CF9000F007C117D:buildSettings:CODE_SIGN_STYLE string Manual" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:CODE_SIGN_STYLE Manual" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:97C147071CF9000F007C117D:buildSettings:CODE_SIGN_STYLE string Manual" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:CODE_SIGN_STYLE Manual" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:249021D4217E4FDB00AE95B9:buildSettings:CODE_SIGN_STYLE string Manual" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:CODE_SIGN_STYLE Manual" Runner.xcodeproj/project.pbxproj
        
        # Set development team (already exists, so use Set)
        /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:DEVELOPMENT_TEAM 6HB8RU2486" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:DEVELOPMENT_TEAM 6HB8RU2486" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:DEVELOPMENT_TEAM 6HB8RU2486" Runner.xcodeproj/project.pbxproj
        
        # Extract UUID from the installed profile for configuration
        UUID=$(security cms -D -i ../app.mobileprovision | grep -A1 "<key>UUID</key>" | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\n\r ')
        echo "Using profile UUID for configuration: $UUID"
        
        # Add provisioning profile specifier (using profile name)
        echo "Setting PROVISIONING_PROFILE_SPECIFIER to 'foodweb'"
        /usr/libexec/PlistBuddy -c "Add :objects:97C147061CF9000F007C117D:buildSettings:PROVISIONING_PROFILE_SPECIFIER string foodweb" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:PROVISIONING_PROFILE_SPECIFIER foodweb" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:97C147071CF9000F007C117D:buildSettings:PROVISIONING_PROFILE_SPECIFIER string foodweb" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:PROVISIONING_PROFILE_SPECIFIER foodweb" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:249021D4217E4FDB00AE95B9:buildSettings:PROVISIONING_PROFILE_SPECIFIER string foodweb" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:PROVISIONING_PROFILE_SPECIFIER foodweb" Runner.xcodeproj/project.pbxproj
        
        # Also set the UUID-based provisioning profile (fallback)
        echo "Setting PROVISIONING_PROFILE to UUID: $UUID"
        /usr/libexec/PlistBuddy -c "Add :objects:97C147061CF9000F007C117D:buildSettings:PROVISIONING_PROFILE string $UUID" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:PROVISIONING_PROFILE $UUID" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:97C147071CF9000F007C117D:buildSettings:PROVISIONING_PROFILE string $UUID" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:PROVISIONING_PROFILE $UUID" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:249021D4217E4FDB00AE95B9:buildSettings:PROVISIONING_PROFILE string $UUID" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:PROVISIONING_PROFILE $UUID" Runner.xcodeproj/project.pbxproj
        
        # Add code signing identity for distribution certificate
        /usr/libexec/PlistBuddy -c "Add :objects:97C147061CF9000F007C117D:buildSettings:CODE_SIGN_IDENTITY string \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:CODE_SIGN_IDENTITY \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:97C147071CF9000F007C117D:buildSettings:CODE_SIGN_IDENTITY string \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:CODE_SIGN_IDENTITY \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:249021D4217E4FDB00AE95B9:buildSettings:CODE_SIGN_IDENTITY string \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:CODE_SIGN_IDENTITY \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj

    - name: Build iOS with xcodebuild directly
      run: |
        cd ios
        # Clean any previous builds
        xcodebuild clean -workspace Runner.xcworkspace -scheme Runner -configuration Release
        
        # Build and archive
        xcodebuild \
          -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath build/Runner.xcarchive \
          archive

        # Export IPA
        xcodebuild \
          -exportArchive \
          -archivePath build/Runner.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build/ipa
    
    - name: Rename IPA file
      run: |
        cd ios/build/ipa
        mv *.ipa foodweb-app-store.ipa
        ls -la *.ipa
    
    - name: Upload IPA for Download
      uses: actions/upload-artifact@v4
      with:
        name: foodweb-ios-ipa
        path: ios/build/ipa/foodweb-app-store.ipa
        retention-days: 30
    
    - name: Display download instructions
      run: |
        echo "ðŸŽ‰ IPA Export Complete!"
        echo ""
        echo "ðŸ“¦ Your signed IPA file is ready for download:"
        echo "   1. Go to the 'Summary' tab of this workflow run"
        echo "   2. Scroll down to 'Artifacts' section"
        echo "   3. Download 'foodweb-ios-ipa.zip'"
        echo "   4. Extract to get 'foodweb-app-store.ipa'"
        echo ""
        echo "ðŸ“§ Send this IPA file to your Apple developer with these instructions:"
        echo "   - Use Xcode Organizer â†’ Distribute App â†’ App Store Connect"
        echo "   - Or use Transporter app from Mac App Store"
        echo "   - Or use command: xcrun altool --upload-app -f foodweb-app-store.ipa -u [apple-id] -p [app-password]"
