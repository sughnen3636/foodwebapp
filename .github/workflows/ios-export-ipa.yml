name: iOS Export IPA for Manual Upload

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: 'Export method (app-store, ad-hoc, development)'
        required: true
        default: 'app-store'

jobs:
  export-ipa:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Install CocoaPods
      run: |
        cd ios
        pod install
    
    - name: Check secrets availability
      run: |
        if [ -z "${{ secrets.P12_BASE64 }}" ]; then
          echo "âŒ P12_BASE64 secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.MOBILEPROVISION_BASE64 }}" ]; then
          echo "âŒ MOBILEPROVISION_BASE64 secret is not set"
          exit 1
        fi
        echo "âœ… All required secrets are available"
    
    - name: Decode iOS signing files
      run: |
        echo "${{ secrets.P12_BASE64 }}" | base64 --decode > ios_cert.p12
        echo "${{ secrets.MOBILEPROVISION_BASE64 }}" | base64 --decode > app.mobileprovision
    
    - name: Install Apple certificate
      run: |
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import ios_cert.p12 -k build.keychain -P "${{ secrets.P12_PASSWORD }}" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
        # List available certificates
        echo "Available certificates:"
        security find-identity -v -p codesigning build.keychain
    
    - name: Install provisioning profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        # Extract and get UUID from the provisioning profile using a more reliable method
        security cms -D -i app.mobileprovision > decoded_profile.plist
        UUID=$(plutil -extract UUID xml1 -o - decoded_profile.plist | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')
        echo "Provisioning profile UUID: $UUID"
        
        # If UUID extraction failed, try alternative method
        if [ -z "$UUID" ]; then
          echo "Primary UUID extraction failed, trying alternative method..."
          UUID=$(security cms -D -i app.mobileprovision | grep -A1 "<key>UUID</key>" | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          echo "Alternative UUID extraction result: $UUID"
        fi
        
        # Copy with proper UUID filename if we have a UUID
        if [ ! -z "$UUID" ]; then
          cp app.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          echo "Installed profile with UUID: $UUID"
        else
          echo "Warning: Could not extract UUID from provisioning profile"
        fi
        
        # Also copy with original name for fallback
        cp app.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision
        
        # List installed profiles
        echo "Installed provisioning profiles:"
        ls -la ~/Library/MobileDevice/Provisioning\ Profiles/
        
        # Verify provisioning profile details
        echo "Provisioning profile details:"
        security cms -D -i app.mobileprovision | head -50
        
        # Check profile name and team ID
        PROFILE_NAME=$(security cms -D -i app.mobileprovision | grep -A1 "<key>Name</key>" | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
        TEAM_ID=$(security cms -D -i app.mobileprovision | grep -A1 "<key>TeamIdentifier</key>" -A1 | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
        echo "Profile Name: $PROFILE_NAME"
        echo "Team ID: $TEAM_ID"
    
    - name: Configure Runner project for manual signing
      run: |
        cd ios
        # Add CODE_SIGN_STYLE to Runner build configurations
        /usr/libexec/PlistBuddy -c "Add :objects:97C147061CF9000F007C117D:buildSettings:CODE_SIGN_STYLE string Manual" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:CODE_SIGN_STYLE Manual" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:97C147071CF9000F007C117D:buildSettings:CODE_SIGN_STYLE string Manual" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:CODE_SIGN_STYLE Manual" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:249021D4217E4FDB00AE95B9:buildSettings:CODE_SIGN_STYLE string Manual" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:CODE_SIGN_STYLE Manual" Runner.xcodeproj/project.pbxproj
        
        # Set development team (already exists, so use Set)
        /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:DEVELOPMENT_TEAM 6HB8RU2486" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:DEVELOPMENT_TEAM 6HB8RU2486" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:DEVELOPMENT_TEAM 6HB8RU2486" Runner.xcodeproj/project.pbxproj
        
        # Add provisioning profile specifier
        /usr/libexec/PlistBuddy -c "Add :objects:97C147061CF9000F007C117D:buildSettings:PROVISIONING_PROFILE_SPECIFIER string foodweb" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:PROVISIONING_PROFILE_SPECIFIER foodweb" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:97C147071CF9000F007C117D:buildSettings:PROVISIONING_PROFILE_SPECIFIER string foodweb" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:PROVISIONING_PROFILE_SPECIFIER foodweb" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:249021D4217E4FDB00AE95B9:buildSettings:PROVISIONING_PROFILE_SPECIFIER string foodweb" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:PROVISIONING_PROFILE_SPECIFIER foodweb" Runner.xcodeproj/project.pbxproj
        
        # Add code signing identity for distribution certificate
        /usr/libexec/PlistBuddy -c "Add :objects:97C147061CF9000F007C117D:buildSettings:CODE_SIGN_IDENTITY string \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147061CF9000F007C117D:buildSettings:CODE_SIGN_IDENTITY \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:97C147071CF9000F007C117D:buildSettings:CODE_SIGN_IDENTITY string \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:97C147071CF9000F007C117D:buildSettings:CODE_SIGN_IDENTITY \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj
        /usr/libexec/PlistBuddy -c "Add :objects:249021D4217E4FDB00AE95B9:buildSettings:CODE_SIGN_IDENTITY string \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj || /usr/libexec/PlistBuddy -c "Set :objects:249021D4217E4FDB00AE95B9:buildSettings:CODE_SIGN_IDENTITY \"iPhone Distribution\"" Runner.xcodeproj/project.pbxproj

    - name: Build iOS with xcodebuild directly
      run: |
        cd ios
        # Clean any previous builds
        xcodebuild clean -workspace Runner.xcworkspace -scheme Runner -configuration Release
        
        # Build and archive
        xcodebuild \
          -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath build/Runner.xcarchive \
          archive

        # Export IPA
        xcodebuild \
          -exportArchive \
          -archivePath build/Runner.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build/ipa
    
    - name: Rename IPA file
      run: |
        cd ios/build/ipa
        mv *.ipa foodweb-app-store.ipa
        ls -la *.ipa
    
    - name: Upload IPA for Download
      uses: actions/upload-artifact@v4
      with:
        name: foodweb-ios-ipa
        path: ios/build/ipa/foodweb-app-store.ipa
        retention-days: 30
    
    - name: Display download instructions
      run: |
        echo "ðŸŽ‰ IPA Export Complete!"
        echo ""
        echo "ðŸ“¦ Your signed IPA file is ready for download:"
        echo "   1. Go to the 'Summary' tab of this workflow run"
        echo "   2. Scroll down to 'Artifacts' section"
        echo "   3. Download 'foodweb-ios-ipa.zip'"
        echo "   4. Extract to get 'foodweb-app-store.ipa'"
        echo ""
        echo "ðŸ“§ Send this IPA file to your Apple developer with these instructions:"
        echo "   - Use Xcode Organizer â†’ Distribute App â†’ App Store Connect"
        echo "   - Or use Transporter app from Mac App Store"
        echo "   - Or use command: xcrun altool --upload-app -f foodweb-app-store.ipa -u [apple-id] -p [app-password]"
